<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaxBet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #4a5568;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .balance {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }
        
        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        input[type="text"], input[type="password"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #ff8c00);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .events-section, .bets-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4a5568;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .event-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .event-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .event-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .event-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .option-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .bet-input {
            max-width: 100px;
            margin-top: 10px;
        }
        
        .admin-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .user-list, .event-list {
            margin-top: 20px;
        }
        
        .user-item, .event-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hidden {
            display: none !important;
        }
        
        .bet-history {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .bet-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #ffc107;
            color: #856404;
        }
        
        .status-won {
            background: #28a745;
            color: white;
        }
        
        .status-lost {
            background: #dc3545;
            color: white;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="authForm" class="auth-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #4a5568;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <div class="form-group">
                <label for="username">–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>
            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">–í–æ–π—Ç–∏</button>
            <p style="text-align: center; margin-top: 15px; color: #718096;">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showRegister()" style="color: #667eea;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </p>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="registerForm" class="hidden" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="newUsername">–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω:</label>
                    <input type="text" id="newUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="newPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn" onclick="register()" style="width: 100%;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
        <div id="app" class="hidden">
            <!-- –®–∞–ø–∫–∞ -->
            <div class="header">
                <div class="logo">üéØ MaxBet</div>
                <div class="user-info">
                    <div class="balance">–ë–∞–ª–∞–Ω—Å: <span id="userBalance">1000</span> –º–æ–Ω–µ—Ç</div>
                    <span id="userRole">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <button class="btn btn-danger" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="main-content">
                <!-- –°–æ–±—ã—Ç–∏—è -->
                <div class="events-section">
                    <h3 class="section-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</h3>
                    <div id="eventsList">
                        <!-- –°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase -->
                    </div>
                </div>

                <!-- –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫ -->
                <div class="bets-section">
                    <h3 class="section-title">–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</h3>
                    <div id="userBets">
                        <!-- –°—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    </div>
                </div>
            </div>

            <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
            <div id="adminPanel" class="admin-panel hidden">
                <h3 class="section-title">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                
                <div class="admin-tabs">
                    <button class="tab active" onclick="showTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                    <button class="tab" onclick="showTab('events')">–°–æ–±—ã—Ç–∏—è</button>
                    <button class="tab" onclick="showTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
                <div id="usersTab" class="tab-content active">
                    <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4>
                    <div class="user-list" id="usersList"></div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏ -->
                <div id="eventsTab" class="tab-content">
                    <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏</h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</label>
                            <input type="text" id="eventTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç—á –°–ø–∞—Ä—Ç–∞–∫ - –¶–°–ö–ê">
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                            <textarea id="eventDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"></textarea>
                        </div>
                        <div class="form-group">
                            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã —Å—Ç–∞–≤–æ–∫ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                            <input type="text" id="eventOptions" placeholder="–ü–æ–±–µ–¥–∞ –∫–æ–º–∞–Ω–¥—ã 1, –ù–∏—á—å—è, –ü–æ–±–µ–¥–∞ –∫–æ–º–∞–Ω–¥—ã 2">
                        </div>
                        <div class="form-group">
                            <label>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                            <input type="text" id="eventCoefficients" placeholder="2.1, 3.2, 1.8">
                        </div>
                        <button class="btn btn-success" onclick="addEvent()">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                    </div>
                    <div class="event-list" id="adminEventsList"></div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div id="settingsTab" class="tab-content">
                    <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div class="form-group">
                            <label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞:</label>
                            <input type="number" id="maxBetAmount" value="500">
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:</label>
                            <input type="number" id="defaultBalance" value="1000">
                        </div>
                        <button class="btn btn-success" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
    <script src="firebase-config.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, update, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ firebase-config.js)
        const app = initializeApp(window.firebaseConfig);
        const database = getDatabase(app);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã
        window.db = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbPush = push;
        window.dbUpdate = update;
        window.dbOnValue = onValue;
        
        let currentUser = null;
        let events = {};
        let users = {};
        let settings = { maxBetAmount: 500, defaultBalance: 1000 };

        // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        window.login = async function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }

            try {
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === password) {
                        currentUser = { username, ...userData };
                        showApp();
                    } else {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    }
                } else {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        };

        window.register = async function() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                    return;
                }

                const newUser = {
                    password: password,
                    balance: settings.defaultBalance,
                    role: 'user',
                    bets: []
                };

                await set(userRef, newUser);
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                
                document.getElementById('username').value = username;
                document.getElementById('password').value = password;
                showLogin();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞');
            }
        };

        window.logout = function() {
            currentUser = null;
            localStorage.removeItem('currentUser'); // –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
            document.getElementById('authForm').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        };

        window.showRegister = function() {
            document.getElementById('registerForm').classList.toggle('hidden');
        };

        window.showLogin = function() {
            document.getElementById('registerForm').classList.add('hidden');
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
        async function showApp() {
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateUserInfo();
            await loadSettings(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–≤—ã–º–∏
            loadEvents();
            loadUserBets();
            
            if (currentUser.role === 'admin' || currentUser.role === 'moderator') {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadUsers();
                loadAdminEvents();
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function updateUserInfo() {
            document.getElementById('userBalance').textContent = currentUser.balance;
            document.getElementById('userRole').textContent = 
                currentUser.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' :
                currentUser.role === 'moderator' ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
        window.loadEvents = async function() {
            try {
                const eventsRef = ref(database, 'events');
                const snapshot = await get(eventsRef);
                
                if (snapshot.exists()) {
                    events = snapshot.val();
                    displayEvents();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
            }
        };

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
        function displayEvents() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '';

            Object.entries(events).forEach(([eventId, event]) => {
                if (event.status === 'active') {
                    const eventCard = createEventCard(eventId, event);
                    eventsList.appendChild(eventCard);
                }
            });
        }

        // –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ–±—ã—Ç–∏—è
        function createEventCard(eventId, event) {
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `
                <div class="event-title">${event.title}</div>
                <div style="color: #666; margin-bottom: 10px;">${event.description}</div>
                <div class="event-options">
                    ${event.options.map((option, index) => `
                        <button class="option-btn" onclick="selectBet('${eventId}', ${index})">
                            ${option} (${event.coefficients[index]})
                        </button>
                    `).join('')}
                </div>
                <div id="betForm_${eventId}" class="hidden" style="margin-top: 15px;">
                    <input type="number" id="betAmount_${eventId}" class="bet-input" placeholder="–°—É–º–º–∞" min="1" max="${settings.maxBetAmount}">
                    <button class="btn btn-success" onclick="placeBet('${eventId}')" style="margin-left: 10px;">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
                    <button class="btn" onclick="cancelBet('${eventId}')" style="margin-left: 5px;">–û—Ç–º–µ–Ω–∞</button>
                    <div id="selectedOption_${eventId}" style="margin-top: 10px; font-weight: bold;"></div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${settings.maxBetAmount} –º–æ–Ω–µ—Ç</div>
                </div>
            `;
            return div;
        }

        // –í—ã–±—Ä–∞—Ç—å —Å—Ç–∞–≤–∫—É
        window.selectBet = function(eventId, optionIndex) {
            const event = events[eventId];
            const betForm = document.getElementById(`betForm_${eventId}`);
            const selectedOption = document.getElementById(`selectedOption_${eventId}`);
            
            betForm.classList.remove('hidden');
            selectedOption.innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${event.options[optionIndex]} (–ö–æ—ç—Ñ—Ñ: ${event.coefficients[optionIndex]})`;
            
            betForm.setAttribute('data-option-index', optionIndex);
        };

        // –û—Ç–º–µ–Ω–∏—Ç—å —Å—Ç–∞–≤–∫—É
        window.cancelBet = function(eventId) {
            const betForm = document.getElementById(`betForm_${eventId}`);
            betForm.classList.add('hidden');
            document.getElementById(`betAmount_${eventId}`).value = '';
        };

        // –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É
        window.placeBet = async function(eventId) {
            const betAmount = parseInt(document.getElementById(`betAmount_${eventId}`).value);
            const optionIndex = parseInt(document.getElementById(`betForm_${eventId}`).getAttribute('data-option-index'));
            
            if (!betAmount || betAmount <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
                return;
            }

            if (betAmount > currentUser.balance) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                return;
            }

            if (betAmount > settings.maxBetAmount) {
                alert(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${settings.maxBetAmount} –º–æ–Ω–µ—Ç`);
                return;
            }

            try {
                const event = events[eventId];
                const bet = {
                    user: currentUser.username,
                    eventId: eventId,
                    eventTitle: event.title,
                    option: event.options[optionIndex],
                    coefficient: event.coefficients[optionIndex],
                    amount: betAmount,
                    status: 'pending',
                    timestamp: Date.now()
                };

                // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–≤–∫—É
                const betsRef = ref(database, 'bets');
                await push(betsRef, bet);

                // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const newBalance = currentUser.balance - betAmount;
                await update(ref(database, `users/${currentUser.username}`), { balance: newBalance });
                currentUser.balance = newBalance;

                updateUserInfo();
                loadUserBets();
                cancelBet(eventId);
                
                alert('–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.loadUserBets = async function() {
            try {
                const betsRef = ref(database, 'bets');
                const snapshot = await get(betsRef);
                
                if (snapshot.exists()) {
                    const allBets = snapshot.val();
                    const userBets = Object.entries(allBets)
                        .filter(([_, bet]) => bet.user === currentUser.username)
                        .sort((a, b) => b[1].timestamp - a[1].timestamp);
                    
                    displayUserBets(userBets);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–≤–æ–∫:', error);
            }
        };

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function displayUserBets(userBets) {
            const betsContainer = document.getElementById('userBets');
            betsContainer.innerHTML = '';

            if (userBets.length === 0) {
                betsContainer.innerHTML = '<p style="color: #666;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞–≤–æ–∫</p>';
                return;
            }

            userBets.forEach(([betId, bet]) => {
                const betDiv = document.createElement('div');
                betDiv.className = 'bet-history';
                betDiv.innerHTML = `
                    <div style="font-weight: bold;">${bet.eventTitle}</div>
                    <div style="color: #666; margin: 5px 0;">–°—Ç–∞–≤–∫–∞: ${bet.option} (${bet.coefficient})</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>–°—É–º–º–∞: ${bet.amount} –º–æ–Ω–µ—Ç</span>
                        <span class="bet-status status-${bet.status}">
                            ${bet.status === 'pending' ? '–í –æ–∂–∏–¥–∞–Ω–∏–∏' : 
                              bet.status === 'won' ? '–í—ã–∏–≥—Ä—ã—à' : '–ü—Ä–æ–∏–≥—Ä—ã—à'}
                        </span>
                    </div>
                    ${bet.status === 'won' ? `<div style="color: #28a745; font-weight: bold; margin-top: 5px;">–í—ã–∏–≥—Ä—ã—à: ${Math.round(bet.amount * bet.coefficient)} –º–æ–Ω–µ—Ç</div>` : ''}
                `;
                betsContainer.appendChild(betDiv);
            });
        }

        // === –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò ===

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        };

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        window.loadUsers = async function() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    users = snapshot.val();
                    displayUsers();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        };

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function displayUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            Object.entries(users).forEach(([username, user]) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.innerHTML = `
                    <div>
                        <strong>${username}</strong> - ${user.balance} –º–æ–Ω–µ—Ç 
                        <span style="color: #666;">(${user.role})</span>
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="changeBalance('${username}')">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                        <select onchange="changeRole('${username}', this.value)">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                            <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        </select>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }

        // –ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.changeBalance = async function(username) {
            const newBalance = prompt(`–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è ${username}:`, users[username].balance);
            if (newBalance !== null && !isNaN(newBalance)) {
                try {
                    await update(ref(database, `users/${username}`), { balance: parseInt(newBalance) });
                    users[username].balance = parseInt(newBalance);
                    
                    if (username === currentUser.username) {
                        currentUser.balance = parseInt(newBalance);
                        updateUserInfo();
                    }
                    
                    displayUsers();
                    alert('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞');
                }
            }
        };

        // –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.changeRole = async function(username, newRole) {
            try {
                await update(ref(database, `users/${username}`), { role: newRole });
                users[username].role = newRole;
                alert('–†–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏');
            }
        };

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
        window.addEvent = async function() {
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const options = document.getElementById('eventOptions').value.split(',').map(s => s.trim());
            const coefficients = document.getElementById('eventCoefficients').value.split(',').map(s => parseFloat(s.trim()));

            if (!title || !description || options.length === 0 || coefficients.length === 0) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            if (options.length !== coefficients.length) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤');
                return;
            }

            try {
                const newEvent = {
                    title,
                    description,
                    options,
                    coefficients,
                    status: 'active',
                    createdBy: currentUser.username,
                    timestamp: Date.now()
                };

                const eventsRef = ref(database, 'events');
                await push(eventsRef, newEvent);

                // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDescription').value = '';
                document.getElementById('eventOptions').value = '';
                document.getElementById('eventCoefficients').value = '';

                loadEvents();
                loadAdminEvents();
                alert('–°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        window.loadAdminEvents = async function() {
            try {
                const eventsRef = ref(database, 'events');
                const snapshot = await get(eventsRef);
                
                if (snapshot.exists()) {
                    events = snapshot.val();
                    displayAdminEvents();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
            }
        };

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
        function displayAdminEvents() {
            const eventsList = document.getElementById('adminEventsList');
            eventsList.innerHTML = '';

            Object.entries(events).forEach(([eventId, event]) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.innerHTML = `
                    <div>
                        <strong>${event.title}</strong><br>
                        <span style="color: #666;">–°—Ç–∞—Ç—É—Å: ${event.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'}</span>
                    </div>
                    <div>
                        ${event.status === 'active' ? `
                            <select onchange="finishEvent('${eventId}', this.value)">
                                <option value="">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</option>
                                ${event.options.map((option, index) => `
                                    <option value="${index}">${option}</option>
                                `).join('')}
                            </select>
                        ` : `<span style="color: #28a745;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>`}
                    </div>
                `;
                eventsList.appendChild(eventDiv);
            });
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
        window.finishEvent = async function(eventId, winningOptionIndex) {
            if (winningOptionIndex === '') return;

            try {
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–±—ã—Ç–∏—è
                await update(ref(database, `events/${eventId}`), { 
                    status: 'finished',
                    result: parseInt(winningOptionIndex)
                });

                // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
                const betsRef = ref(database, 'bets');
                const betsSnapshot = await get(betsRef);
                
                if (betsSnapshot.exists()) {
                    const allBets = betsSnapshot.val();
                    
                    for (const [betId, bet] of Object.entries(allBets)) {
                        if (bet.eventId === eventId && bet.status === 'pending') {
                            const betOptionIndex = events[eventId].options.indexOf(bet.option);
                            const won = betOptionIndex === parseInt(winningOptionIndex);
                            
                            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–≤–∫–∏
                            await update(ref(database, `bets/${betId}`), { 
                                status: won ? 'won' : 'lost' 
                            });

                            // –ï—Å–ª–∏ –≤—ã–∏–≥—Ä–∞–ª, –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∏–≥—Ä—ã—à –∫ –±–∞–ª–∞–Ω—Å—É
                            if (won) {
                                const userRef = ref(database, `users/${bet.user}`);
                                const userSnapshot = await get(userRef);
                                if (userSnapshot.exists()) {
                                    const userData = userSnapshot.val();
                                    const winAmount = Math.round(bet.amount * bet.coefficient);
                                    await update(userRef, { 
                                        balance: userData.balance + winAmount 
                                    });
                                }
                            }
                        }
                    }
                }

                loadEvents();
                loadAdminEvents();
                loadUserBets();
                alert('–°–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –≤—ã–∏–≥—Ä—ã—à–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
            }
        };

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        window.loadSettings = async function() {
            try {
                const settingsRef = ref(database, 'settings');
                const snapshot = await get(settingsRef);
                
                if (snapshot.exists()) {
                    settings = snapshot.val();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤ –∞–¥–º–∏–Ω–∫–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (document.getElementById('maxBetAmount')) {
                        document.getElementById('maxBetAmount').value = settings.maxBetAmount;
                    }
                    if (document.getElementById('defaultBalance')) {
                        document.getElementById('defaultBalance').value = settings.defaultBalance;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        };

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        window.saveSettings = async function() {
            const maxBetAmount = parseInt(document.getElementById('maxBetAmount').value);
            const defaultBalance = parseInt(document.getElementById('defaultBalance').value);

            try {
                settings = { maxBetAmount, defaultBalance };
                await set(ref(database, 'settings'), settings);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Å –Ω–æ–≤—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
                displayEvents();
                
                alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
        window.addEventListener('load', async function() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Firebase
                const settingsRef = ref(database, 'settings');
                const snapshot = await get(settingsRef);
                
                if (!snapshot.exists()) {
                    await set(settingsRef, settings);
                } else {
                    settings = snapshot.val();
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const userData = JSON.parse(savedUser);
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ
                        const userRef = ref(database, `users/${userData.username}`);
                        const userSnapshot = await get(userRef);
                        
                        if (userSnapshot.exists()) {
                            currentUser = { ...userData, ...userSnapshot.val() };
                            showApp();
                        } else {
                            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª —É–¥–∞–ª–µ–Ω, –æ—á–∏—â–∞–µ–º localStorage
                            localStorage.removeItem('currentUser');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                        localStorage.removeItem('currentUser');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        });
    </script>
</body>
</html>
