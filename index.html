<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaxBet - Платформа ставок</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .user-panel {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .balance {
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar h3 {
            margin-bottom: 15px;
            color: #4fc3f7;
            font-size: 18px;
        }
        
        .category {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .category:hover {
            background: rgba(79, 195, 247, 0.1);
            border-color: rgba(79, 195, 247, 0.3);
        }
        
        .category.active {
            background: rgba(79, 195, 247, 0.2);
            border-color: #4fc3f7;
        }
        
        .events-container {
            padding: 20px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .event-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(79, 195, 247, 0.5);
        }
        
        .event-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .event-description {
            color: #b0bec5;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .event-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .option-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .option-button:hover {
            background: rgba(79, 195, 247, 0.2);
            border-color: #4fc3f7;
            transform: scale(1.02);
        }
        
        .option-button.selected {
            background: rgba(79, 195, 247, 0.3);
            border-color: #4fc3f7;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }
        
        .option-text {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .option-coefficient {
            font-size: 16px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .bet-slip {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }
        
        .bet-slip h3 {
            margin-bottom: 20px;
            color: #4fc3f7;
            font-size: 18px;
        }
        
        .bet-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .bet-event-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .bet-option {
            font-size: 12px;
            color: #b0bec5;
            margin-bottom: 5px;
        }
        
        .bet-coefficient {
            font-size: 16px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .remove-bet {
            float: right;
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 18px;
        }
        
        .bet-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .bet-type-selector {
            margin-bottom: 15px;
        }
        
        .bet-type-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
            font-size: 12px;
        }
        
        .bet-type-button.active {
            background: #4fc3f7;
            border-color: #4fc3f7;
        }
        
        .stake-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            margin-bottom: 10px;
        }
        
        .stake-input::placeholder {
            color: #b0bec5;
        }
        
        .potential-payout {
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .place-bet-button {
            width: 100%;
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            border: none;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .place-bet-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);
        }
        
        .place-bet-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .clear-all {
            width: 100%;
            background: transparent;
            border: 1px solid #f44336;
            color: #f44336;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .clear-all:hover {
            background: rgba(244, 67, 54, 0.1);
        }
        
        .empty-betslip {
            text-align: center;
            color: #b0bec5;
            padding: 40px 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 15px;
            padding: 30px;
            min-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #b0bec5;
        }
        
        .close:hover {
            color: #fff;
        }
        
        .auth-form {
            max-width: 300px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .btn {
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);
        }
        
        .admin-panel {
            background: rgba(255, 255, 255, 0.05);
            margin: 20px;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 200px 1fr 280px;
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            
            .sidebar, .bet-slip {
                position: fixed;
                top: 70px;
                right: -100%;
                width: 300px;
                height: calc(100vh - 70px);
                transition: right 0.3s;
                z-index: 100;
            }
            
            .sidebar.open, .bet-slip.open {
                right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Форма авторизации -->
    <div id="authForm" class="auth-form">
        <h2 style="text-align: center; margin-bottom: 30px; color: #4fc3f7;">Вход в MaxBet</h2>
        <div class="form-group">
            <label for="username">Логин:</label>
            <input type="text" id="username" placeholder="Введите логин">
        </div>
        <div class="form-group">
            <label for="password">Пароль:</label>
            <input type="password" id="password" placeholder="Введите пароль">
        </div>
        <button class="btn" onclick="login()" style="width: 100%;">Войти</button>
        <p style="text-align: center; margin-top: 15px; color: #b0bec5;">
            Нет аккаунта? <a href="#" onclick="showRegister()" style="color: #4fc3f7;">Регистрация</a>
        </p>
        
        <div id="registerForm" class="hidden" style="margin-top: 20px;">
            <div class="form-group">
                <label for="newUsername">Новый логин:</label>
                <input type="text" id="newUsername" placeholder="Придумайте логин">
            </div>
            <div class="form-group">
                <label for="newPassword">Новый пароль:</label>
                <input type="password" id="newPassword" placeholder="Придумайте пароль">
            </div>
            <button class="btn" onclick="register()" style="width: 100%;">Зарегистрироваться</button>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="app" class="hidden">
        <!-- Шапка -->
        <div class="header">
            <div class="logo">🎯 MaxBet</div>
            <div class="user-panel">
                <div class="balance">Баланс: <span id="userBalance">1000</span> монет</div>
                <span id="userRole">Пользователь</span>
                <button class="btn" onclick="logout()">Выйти</button>
            </div>
        </div>

        <!-- Основной контейнер -->
        <div class="main-container">
            <!-- Боковая панель с категориями -->
            <div class="sidebar">
                <h3>Категории</h3>
                <div class="category active" onclick="selectCategory('politics')" data-category="politics">
                    🏛️ Политика
                </div>
                <div class="category" onclick="selectCategory('entertainment')" data-category="entertainment">
                    🎭 Развлечения
                </div>
                <div class="category" onclick="selectCategory('technology')" data-category="technology">
                    💻 Технологии
                </div>
                <div class="category" onclick="selectCategory('economics')" data-category="economics">
                    💰 Экономика
                </div>
                <div class="category" onclick="selectCategory('weather')" data-category="weather">
                    🌤️ Погода
                </div>
                <div class="category" onclick="selectCategory('society')" data-category="society">
                    👥 Общество
                </div>
            </div>

            <!-- Центральная область с событиями -->
            <div class="events-container" id="eventsContainer">
                <!-- События будут загружены динамически -->
            </div>

            <!-- Купон ставок -->
            <div class="bet-slip">
                <h3>Купон ставок</h3>
                <div id="betSlipContent">
                    <div class="empty-betslip">
                        <p>Выберите события для ставки</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Админ панель -->
        <div id="adminPanel" class="admin-panel hidden">
            <h3 style="color: #4fc3f7; margin-bottom: 20px;">Панель администратора</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Добавление события -->
                <div>
                    <h4 style="margin-bottom: 15px;">Добавить событие</h4>
                    <div class="form-group">
                        <label>Категория:</label>
                        <select id="eventCategory" style="width: 100%; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #fff;">
                            <option value="politics">Политика</option>
                            <option value="entertainment">Развлечения</option>
                            <option value="technology">Технологии</option>
                            <option value="economics">Экономика</option>
                            <option value="weather">Погода</option>
                            <option value="society">Общество</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Название события:</label>
                        <input type="text" id="eventTitle" placeholder="Например: Выборы президента 2025">
                    </div>
                    <div class="form-group">
                        <label>Описание:</label>
                        <textarea id="eventDescription" placeholder="Подробное описание события" style="width: 100%; height: 80px; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #fff; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Варианты (через запятую):</label>
                        <input type="text" id="eventOptions" placeholder="Да, Нет, Возможно">
                    </div>
                    <div class="form-group">
                        <label>Коэффициенты (через запятую):</label>
                        <input type="text" id="eventCoefficients" placeholder="1.5, 2.0, 3.2">
                    </div>
                    <button class="btn" onclick="addEvent()">Добавить событие</button>
                </div>

                <!-- Управление событиями -->
                <div>
                    <h4 style="margin-bottom: 15px;">Активные события</h4>
                    <div id="adminEventsList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения ставки -->
    <div id="betModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBetModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #4fc3f7;">Подтверждение ставки</h2>
            <div id="betModalContent"></div>
        </div>
    </div>

    <!-- Firebase конфигурация -->
    <script src="firebase-config.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, update, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Инициализация Firebase
        const app = initializeApp(window.firebaseConfig);
        const database = getDatabase(app);

        // Глобальные переменные
        window.db = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbPush = push;
        window.dbUpdate = update;
        
        let currentUser = null;
        let events = {};
        let settings = { maxBetAmount: 1000, defaultBalance: 5000 };
        let selectedBets = []; // Корзина ставок
        let currentCategory = 'politics';

        // === АВТОРИЗАЦИЯ ===
        window.login = async function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Введите логин и пароль');
                return;
            }

            try {
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === password) {
                        currentUser = { username, ...userData };
                        showApp();
                    } else {
                        alert('Неверный пароль');
                    }
                } else {
                    alert('Пользователь не найден');
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                alert('Ошибка подключения к базе данных');
            }
        };

        window.register = async function() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            
            if (!username || !password) {
                alert('Заполните все поля');
                return;
            }

            try {
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    alert('Пользователь уже существует');
                    return;
                }

                const newUser = {
                    password: password,
                    balance: settings.defaultBalance,
                    role: 'user'
                };

                await set(userRef, newUser);
                alert('Регистрация успешна!');
                
                document.getElementById('username').value = username;
                document.getElementById('password').value = password;
                showLogin();
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                alert('Ошибка создания аккаунта');
            }
        };

        window.logout = function() {
            currentUser = null;
            selectedBets = [];
            localStorage.removeItem('currentUser');
            document.getElementById('authForm').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        };

        window.showRegister = function() {
            document.getElementById('registerForm').classList.toggle('hidden');
        };

        window.showLogin = function() {
            document.getElementById('registerForm').classList.add('hidden');
        };

        // Показать приложение
        async function showApp() {
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateUserInfo();
            await loadSettings();
            loadEvents();
            
            if (currentUser.role === 'admin' || currentUser.role === 'moderator') {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminEvents();
            }
        }

        function updateUserInfo() {
            document.getElementById('userBalance').textContent = currentUser.balance;
            document.getElementById('userRole').textContent = 
                currentUser.role === 'admin' ? 'Администратор' :
                currentUser.role === 'moderator' ? 'Модератор' : 'Пользователь';
        }

        // === КАТЕГОРИИ И СОБЫТИЯ ===
        window.selectCategory = function(category) {
            currentCategory = category;
            
            // Обновить активную категорию
            document.querySelectorAll('.category').forEach(cat => cat.classList.remove('active'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            displayEvents();
        };

        window.loadEvents = async function() {
            try {
                const eventsRef = ref(database, 'events');
                const snapshot = await get(eventsRef);
                
                if (snapshot.exists()) {
                    events = snapshot.val();
                    displayEvents();
                }
            } catch (error) {
                console.error('Ошибка загрузки событий:', error);
            }
        };

        function displayEvents() {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '';

            const categoryEvents = Object.entries(events).filter(([_, event]) => 
                event.category === currentCategory && event.status === 'active'
            );

            if (categoryEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #b0bec5;">
                        <h3>Нет доступных событий в этой категории</h3>
                        <p>Скоро здесь появятся новые события</p>
                    </div>
                `;
                return;
            }

            categoryEvents.forEach(([eventId, event]) => {
                const eventCard = createEventCard(eventId, event);
                container.appendChild(eventCard);
            });
        }

        function createEventCard(eventId, event) {
            const div = document.createElement('div');
            div.className = 'event-card';
            
            div.innerHTML = `
                <div class="event-title">${event.title}</div>
                <div class="event-description">${event.description}</div>
                <div class="event-options">
                    ${event.options.map((option, index) => `
                        <div class="option-button" onclick="toggleBetSelection('${eventId}', ${index})">
                            <div class="option-text">${option}</div>
                            <div class="option-coefficient">${event.coefficients[index]}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            return div;
        }

        // === КОРЗИНА СТАВОК ===
        window.toggleBetSelection = function(eventId, optionIndex) {
            const event = events[eventId];
            const betKey = `${eventId}_${optionIndex}`;
            
            // Проверяем, есть ли уже ставка из этого события
            const existingBetIndex = selectedBets.findIndex(bet => bet.eventId === eventId);
            
            if (existingBetIndex !== -1) {
                // Если это та же опция, убираем
                if (selectedBets[existingBetIndex].optionIndex === optionIndex) {
                    selectedBets.splice(existingBetIndex, 1);
                } else {
                    // Заменяем на новую опцию
                    selectedBets[existingBetIndex] = {
                        eventId,
                        optionIndex,
                        eventTitle: event.title,
                        option: event.options[optionIndex],
                        coefficient: event.coefficients[optionIndex]
                    };
                }
            } else {
                // Добавляем новую ставку
                selectedBets.push({
                    eventId,
                    optionIndex,
                    eventTitle: event.title,
                    option: event.options[optionIndex],
                    coefficient: event.coefficients[optionIndex]
                });
            }
            
            updateBetSlip();
            updateEventButtons();
        };

        function updateBetSlip() {
            const container = document.getElementById('betSlipContent');
            
            if (selectedBets.length === 0) {
                container.innerHTML = `
                    <div class="empty-betslip">
                        <p>Выберите события для ставки</p>
                    </div>
                `;
                return;
            }

            const totalCoefficient = selectedBets.reduce((acc, bet) => acc * bet.coefficient, 1);
            
            container.innerHTML = `
                <button class="clear-all" onclick="clearAllBets()">Очистить всё</button>
                
                <div style="margin-bottom: 20px;">
                    ${selectedBets.map((bet, index) => `
                        <div class="bet-item">
                            <button class="remove-bet" onclick="removeBet(${index})">&times;</button>
                            <div class="bet-event-title">${bet.eventTitle}</div>
                            <div class="bet-option">${bet.option}</div>
                            <div class="bet-coefficient">${bet.coefficient}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="bet-summary">
                    <div class="bet-type-selector">
                        <button class="bet-type-button ${selectedBets.length === 1 ? 'active' : ''}" 
                                onclick="setBetType('single')" ${selectedBets.length > 1 ? 'disabled' : ''}>
                            Одиночная
                        </button>
                        <button class="bet-type-button ${selectedBets.length > 1 ? 'active' : ''}" 
                                onclick="setBetType('express')" ${selectedBets.length === 1 ? 'disabled' : ''}>
                            Экспресс
                        </button>
                    </div>
                    
                    <input type="number" class="stake-input" id="stakeAmount" 
                           placeholder="Сумма ставки" min="1" max="${settings.maxBetAmount}"
                           onInput="updatePotentialPayout()">
                    
                    <div class="potential-payout">
                        <strong>Общий коэффициент: ${totalCoefficient.toFixed(2)}</strong><br>
                        <span id="potentialPayout">Возможный выигрыш: 0 монет</span>
                    </div>
                    
                    <button class="place-bet-button" onclick="showBetModal()" 
                            ${selectedBets.length === 0 ? 'disabled' : ''}>
                        Сделать ставку
                    </button>
                </div>
            `;
        }

        function updateEventButtons() {
            // Обновляем визуальное состояние кнопок событий
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            selectedBets.forEach(bet => {
                const buttons = document.querySelectorAll('.event-card .option-button');
                buttons.forEach((btn, globalIndex) => {
                    // Находим кнопку по данным
                    if (btn.onclick && btn.onclick.toString().includes(`'${bet.eventId}', ${bet.optionIndex}`)) {
                        btn.classList.add('selected');
                    }
                });
            });
        }

        window.removeBet = function(index) {
            selectedBets.splice(index, 1);
            updateBetSlip();
            updateEventButtons();
        };

        window.clearAllBets = function() {
            selectedBets = [];
            updateBetSlip();
            updateEventButtons();
        };

        window.updatePotentialPayout = function() {
            const stake = parseFloat(document.getElementById('stakeAmount').value) || 0;
            const totalCoefficient = selectedBets.reduce((acc, bet) => acc * bet.coefficient, 1);
            const payout = (stake * totalCoefficient).toFixed(2);
            
            document.getElementById('potentialPayout').textContent = 
                `Возможный выигрыш: ${payout} монет`;
        };

        // === МОДАЛЬНОЕ ОКНО СТАВКИ ===
        window.showBetModal = function() {
            const stake = parseFloat(document.getElementById('stakeAmount').value);
            
            if (!stake || stake <= 0) {
                alert('Введите сумму ставки');
                return;
            }

            if (stake > currentUser.balance) {
                alert('Недостаточно средств');
                return;
            }

            if (stake > settings.maxBetAmount) {
                alert(`Максимальная ставка: ${settings.maxBetAmount} монет`);
                return;
            }

            const totalCoefficient = selectedBets.reduce((acc, bet) => acc * bet.coefficient, 1);
            const potentialPayout = (stake * totalCoefficient).toFixed(2);
            const betType = selectedBets.length === 1 ? 'single' : 'express';

            document.getElementById('betModalContent').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>Тип ставки: ${betType === 'single' ? 'Одиночная' : 'Экспресс'}</h4>
                    <p><strong>Сумма ставки:</strong> ${stake} монет</p>
                    <p><strong>Общий коэффициент:</strong> ${totalCoefficient.toFixed(2)}</p>
                    <p><strong>Возможный выигрыш:</strong> ${potentialPayout} монет</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Выбранные события:</h4>
                    ${selectedBets.map(bet => `
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 5px 0; border-radius: 8px;">
                            <strong>${bet.eventTitle}</strong><br>
                            ${bet.option} (${bet.coefficient})
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="placeBet()" style="flex: 1;">Подтвердить</button>
                    <button class="btn" onclick="closeBetModal()" style="flex: 1; background: #666;">Отмена</button>
                </div>
            `;

            document.getElementById('betModal').style.display = 'block';
        };

        window.closeBetModal = function() {
            document.getElementById('betModal').style.display = 'none';
        };

        window.placeBet = async function() {
            const stake = parseFloat(document.getElementById('stakeAmount').value);
            const totalCoefficient = selectedBets.reduce((acc, bet) => acc * bet.coefficient, 1);
            const betType = selectedBets.length === 1 ? 'single' : 'express';

            try {
                const bet = {
                    user: currentUser.username,
                    type: betType,
                    events: selectedBets,
                    amount: stake,
                    coefficient: totalCoefficient,
                    status: 'pending',
                    timestamp: Date.now()
                };

                // Добавить ставку
                const betsRef = ref(database, 'bets');
                await push(betsRef, bet);

                // Обновить баланс
                const newBalance = currentUser.balance - stake;
                await update(ref(database, `users/${currentUser.username}`), { balance: newBalance });
                currentUser.balance = newBalance;

                updateUserInfo();
                clearAllBets();
                closeBetModal();
                
                alert('Ставка принята!');
            } catch (error) {
                console.error('Ошибка размещения ставки:', error);
                alert('Ошибка размещения ставки');
            }
        };

        // === АДМИН ФУНКЦИИ ===
        window.addEvent = async function() {
            const category = document.getElementById('eventCategory').value;
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const options = document.getElementById('eventOptions').value.split(',').map(s => s.trim());
            const coefficients = document.getElementById('eventCoefficients').value.split(',').map(s => parseFloat(s.trim()));

            if (!title || !description || options.length === 0 || coefficients.length === 0) {
                alert('Заполните все поля');
                return;
            }

            if (options.length !== coefficients.length) {
                alert('Количество вариантов должно совпадать с количеством коэффициентов');
                return;
            }

            try {
                const newEvent = {
                    category,
                    title,
                    description,
                    options,
                    coefficients,
                    status: 'active',
                    createdBy: currentUser.username,
                    timestamp: Date.now()
                };

                const eventsRef = ref(database, 'events');
                await push(eventsRef, newEvent);

                // Очистить форму
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDescription').value = '';
                document.getElementById('eventOptions').value = '';
                document.getElementById('eventCoefficients').value = '';

                loadEvents();
                loadAdminEvents();
                alert('Событие добавлено');
            } catch (error) {
                console.error('Ошибка добавления события:', error);
                alert('Ошибка добавления события');
            }
        };

        window.loadAdminEvents = async function() {
            try {
                const eventsRef = ref(database, 'events');
                const snapshot = await get(eventsRef);
                
                if (snapshot.exists()) {
                    events = snapshot.val();
                    displayAdminEvents();
                }
            } catch (error) {
                console.error('Ошибка загрузки событий:', error);
            }
        };

        function displayAdminEvents() {
            const container = document.getElementById('adminEventsList');
            container.innerHTML = '';

            Object.entries(events).forEach(([eventId, event]) => {
                const eventDiv = document.createElement('div');
                eventDiv.style.cssText = `
                    background: rgba(255,255,255,0.1);
                    padding: 15px;
                    margin-bottom: 10px;
                    border-radius: 8px;
                    border: 1px solid rgba(255,255,255,0.1);
                `;
                eventDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${event.title}</div>
                    <div style="font-size: 12px; color: #b0bec5; margin-bottom: 10px;">
                        ${event.category} | Статус: ${event.status === 'active' ? 'Активно' : 'Завершено'}
                    </div>
                    ${event.status === 'active' ? `
                        <select onchange="finishEvent('${eventId}', this.value)" style="padding: 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="">Завершить событие</option>
                            ${event.options.map((option, index) => `
                                <option value="${index}">${option}</option>
                            `).join('')}
                        </select>
                    ` : `<span style="color: #4fc3f7;">Завершено</span>`}
                `;
                container.appendChild(eventDiv);
            });
        }

        window.finishEvent = async function(eventId, winningOptionIndex) {
            if (winningOptionIndex === '') return;

            try {
                // Обновить статус события
                await update(ref(database, `events/${eventId}`), { 
                    status: 'finished',
                    result: parseInt(winningOptionIndex)
                });

                // Обработать ставки
                const betsRef = ref(database, 'bets');
                const betsSnapshot = await get(betsRef);
                
                if (betsSnapshot.exists()) {
                    const allBets = betsSnapshot.val();
                    
                    for (const [betId, bet] of Object.entries(allBets)) {
                        if (bet.status === 'pending') {
                            let won = false;
                            
                            if (bet.type === 'single') {
                                // Для одиночной ставки
                                const eventBet = bet.events.find(e => e.eventId === eventId);
                                if (eventBet) {
                                    won = eventBet.optionIndex === parseInt(winningOptionIndex);
                                }
                            } else if (bet.type === 'express') {
                                // Для экспресса - проверяем все события
                                const eventBet = bet.events.find(e => e.eventId === eventId);
                                if (eventBet) {
                                    const eventWon = eventBet.optionIndex === parseInt(winningOptionIndex);
                                    if (!eventWon) {
                                        // Если хотя бы одно событие проиграно, весь экспресс проигран
                                        await update(ref(database, `bets/${betId}`), { status: 'lost' });
                                        continue;
                                    }
                                    
                                    // Проверяем, все ли события в экспрессе завершены
                                    const allEventsFinished = bet.events.every(e => {
                                        const event = events[e.eventId];
                                        return event && event.status === 'finished';
                                    });
                                    
                                    if (allEventsFinished) {
                                        // Проверяем, выиграны ли все события
                                        const allEventsWon = bet.events.every(e => {
                                            const event = events[e.eventId];
                                            return event && event.result === e.optionIndex;
                                        });
                                        
                                        won = allEventsWon;
                                    } else {
                                        continue; // Ждем завершения остальных событий
                                    }
                                }
                            }
                            
                            if (bet.events.some(e => e.eventId === eventId)) {
                                if (bet.type === 'single' || 
                                    (bet.type === 'express' && bet.events.every(e => events[e.eventId] && events[e.eventId].status === 'finished'))) {
                                    
                                    await update(ref(database, `bets/${betId}`), { 
                                        status: won ? 'won' : 'lost' 
                                    });

                                    // Начислить выигрыш
                                    if (won) {
                                        const userRef = ref(database, `users/${bet.user}`);
                                        const userSnapshot = await get(userRef);
                                        if (userSnapshot.exists()) {
                                            const userData = userSnapshot.val();
                                            const winAmount = Math.round(bet.amount * bet.coefficient);
                                            await update(userRef, { 
                                                balance: userData.balance + winAmount 
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                loadEvents();
                loadAdminEvents();
                alert('Событие завершено!');
            } catch (error) {
                console.error('Ошибка завершения события:', error);
                alert('Ошибка завершения события');
            }
        };

        window.loadSettings = async function() {
            try {
                const settingsRef = ref(database, 'settings');
                const snapshot = await get(settingsRef);
                
                if (snapshot.exists()) {
                    settings = snapshot.val();
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек:', error);
            }
        };

        // Инициализация
        window.addEventListener('load', async function() {
            try {
                const settingsRef = ref(database, 'settings');
                const snapshot = await get(settingsRef);
                
                if (!snapshot.exists()) {
                    await set(settingsRef, settings);
                } else {
                    settings = snapshot.val();
                }

                // Восстановление сессии
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const userData = JSON.parse(savedUser);
                        const userRef = ref(database, `users/${userData.username}`);
                        const userSnapshot = await get(userRef);
                        
                        if (userSnapshot.exists()) {
                            currentUser = { ...userData, ...userSnapshot.val() };
                            showApp();
                        } else {
                            localStorage.removeItem('currentUser');
                        }
                    } catch (error) {
                        localStorage.removeItem('currentUser');
                    }
                }
            } catch (error) {
                console.error('Ошибка инициализации:', error);
            }
        });

        // Закрытие модального окна по клику вне его
        window.onclick = function(event) {
            const modal = document.getElementById('betModal');
            if (event.target === modal) {
                closeBetModal();
            }
        };
    </script>
</body>
</html>
