// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE =====
// –ò—Å–ø–æ–ª—å–∑—É–µ–º Firebase compat API –≤–º–µ—Å—Ç–æ ES6 –∏–º–ø–æ—Ä—Ç–æ–≤

// ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
let currentUser = null;
let events = {};
let bets = {};

// ===== –í–´–•–û–î =====
function logout() {
    try {
        // –û—á–∏—Å—Ç–∏—Ç—å sync manager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if (window.dataSyncManager) {
            window.dataSyncManager.cleanup();
            window.dataSyncManager.clearLocalData();
        }
        
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã:', error);
        window.location.href = 'login.html';
    }
}

// ===== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê =====
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'none';
}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
window.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è moderator.js');
    
    try {
        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
        await waitForFirebase();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        await checkAuth();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadData();
        
        console.log('‚úÖ moderator.js –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ moderator.js:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
    }
});

// ===== –û–ñ–ò–î–ê–ù–ò–ï FIREBASE =====
async function waitForFirebase() {
    let attempts = 0;
    const maxAttempts = 50;
    
    while (!window.firebase && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (!window.firebase) {
        throw new Error('Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    }
    
    console.log('üî• Firebase –≥–æ—Ç–æ–≤ –¥–ª—è moderator.js');
}

window.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
});

async function checkAuth() {
    const savedUser = localStorage.getItem('currentUser');
    if (!savedUser) {
        window.location.href = 'login.html';
        return;
    }

    currentUser = JSON.parse(savedUser);

    if (currentUser.role !== 'moderator' && currentUser.role !== 'admin') {
        window.location.href = 'main.html';
        return;
    }

    updateUserInfo();
}

function updateUserInfo() {
    if (!currentUser) return;
    
    const balanceElement = document.getElementById('user-balance');
    const usernameElement = document.getElementById('username');
    
    if (balanceElement) {
        balanceElement.textContent = `${currentUser.balance.toLocaleString()} –ª—É–ø–∞–Ω—á–∏–∫–æ–≤`;
    }
    
    if (usernameElement) {
        usernameElement.textContent = currentUser.username;
    }
}

// ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• =====
async function loadData() {
    await Promise.all([
        loadEvents(),
        loadBets()
    ]);
}

// ===== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö =====
function switchTab(tabName) {
    document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    event.target.classList.add('active');
}

// ===== –°–û–ë–´–¢–ò–Ø =====
async function loadEvents() {
    try {
        const eventsRef = window.firebase.database().ref('events');
        const snapshot = await eventsRef.once('value');
        if (snapshot.exists()) {
            events = snapshot.val();
            displayEvents();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
    }
}

function displayEvents() {
    const container = document.getElementById('adminEventsList');
    if (!container) return;

    if (Object.keys(events).length === 0) {
        container.innerHTML = '<p>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
        return;
    }

    container.innerHTML = Object.entries(events).map(([id, event]) => `
        <div style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${event.title}</strong><br>
                    <small>${event.category} | ${event.status}</small>
                </div>
                <div>
                    <button class="btn" onclick="editEvent('${id}')" style="margin-right:5px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-danger" onclick="deleteEvent('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
                    ${event.status === 'active' ? `<button class='btn btn-success' onclick="openFinishEventModal('${id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

async function addEvent() {
    const category = document.getElementById('eventCategory').value;
    const title = document.getElementById('eventTitle').value.trim();
    const description = document.getElementById('eventDescription').value.trim();
    const options = document.getElementById('eventOptions').value.split(',').map(o => o.trim());
    const coefficients = document.getElementById('eventCoefficients').value.split(',').map(c => parseFloat(c.trim()));

    if (!title || !description || options.length === 0 || coefficients.length === 0) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
    }
    if (options.length !== coefficients.length) {
        showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤', 'error');
        return;
    }

    try {
        const newEvent = { title, description, category, options, coefficients, status: 'active', createdAt: Date.now() };
        const eventsRef = window.firebase.database().ref('events');
        const newEventRef = eventsRef.push();
        await newEventRef.set(newEvent);

        document.getElementById('eventTitle').value = '';
        document.getElementById('eventDescription').value = '';
        document.getElementById('eventOptions').value = '';
        document.getElementById('eventCoefficients').value = '';

        showNotification('–°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
        loadEvents();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è', 'error');
    }
}

async function editEvent(eventId) {
    const event = events[eventId];
    if (!event) {
        showNotification('–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }
    document.getElementById('eventCategory').value = event.category;
    document.getElementById('eventTitle').value = event.title;
    document.getElementById('eventDescription').value = event.description;
    document.getElementById('eventOptions').value = event.options.join(', ');
    document.getElementById('eventCoefficients').value = event.coefficients.join(', ');
    showNotification('–§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ"', 'info');
}

async function deleteEvent(eventId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?')) return;
    try {
        const eventRef = window.firebase.database().ref(`events/${eventId}`);
        await eventRef.remove();
        showNotification('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ!', 'success');
        loadEvents();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
        showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è', 'error');
    }
}

function openFinishEventModal(eventId) {
    const event = events[eventId];
    if (!event) return;
    document.getElementById('finishEventTitle').textContent = event.title;
    const select = document.getElementById('finishEventOption');
    select.innerHTML = event.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
    select.dataset.eventId = eventId;
    document.getElementById('finishEventModal').style.display = 'block';
}

async function finishEventConfirm() {
    const select = document.getElementById('finishEventOption');
    const eventId = select.dataset.eventId;
    const winningOption = select.value;
    if (!eventId || !winningOption) return;
    
    try {
        // 1. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ: —Å—Ç–∞—Ç—É—Å –∏ winningOption
        const eventRef = window.firebase.database().ref(`events/${eventId}`);
        await eventRef.update({ status: 'finished', winningOption });
        
        // 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å—Ç–∞–≤–∫–∏ –ø–æ —ç—Ç–æ–º—É —Å–æ–±—ã—Ç–∏—é
        let updated = 0;
        for (const [betId, bet] of Object.entries(bets)) {
            if (bet.status !== 'pending') continue;
            // –ï—Å—Ç—å –ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤ —Å—Ç–∞–≤–∫–µ?
            const betEvent = (bet.events || []).find(e => e.eventId === eventId);
            if (!betEvent) continue;
            let isWin = betEvent.option === winningOption;
            let updateData = { status: isWin ? 'won' : 'lost' };
            if (isWin) {
                updateData.winAmount = bet.amount * bet.coefficient;
                // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userRef = window.firebase.database().ref(`users/${bet.user}`);
                const userSnapshot = await userRef.once('value');
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    const newBalance = userData.balance + updateData.winAmount;
                    await userRef.update({ balance: newBalance });
                }
            }
            const betRef = window.firebase.database().ref(`bets/${betId}`);
            await betRef.update(updateData);
            updated++;
        }
        closeModal('finishEventModal');
        showNotification(`–°–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ —Å—Ç–∞–≤–æ–∫: ${updated}`, 'success');
        loadEvents();
        loadBets();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è', 'error');
    }
}

// ===== –°–¢–ê–í–ö–ò =====
async function loadBets() {
    try {
        const betsRef = window.firebase.database().ref('bets');
        const snapshot = await betsRef.once('value');
        if (snapshot.exists()) {
            bets = snapshot.val();
            displayBets();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–≤–æ–∫:', error);
    }
}

function displayBets() {
    const tbody = document.getElementById('betsTableBody');
    if (!tbody) return;
    
    const filteredBets = filterBets();
    
    tbody.innerHTML = filteredBets.map(([betId, bet]) => `
        <tr>
            <td>${betId.substring(0, 8)}</td>
            <td>${bet.user}</td>
            <td>${bet.type === 'single' ? '–û–¥–∏–Ω–æ—á–Ω–∞—è' : '–≠–∫—Å–ø—Ä–µ—Å—Å'}</td>
            <td>${bet.amount}</td>
            <td>${bet.coefficient}</td>
            <td>${(bet.amount * bet.coefficient).toFixed(2)}</td>
            <td><span class="status-${bet.status}">${getBetStatusName(bet.status)}</span></td>
            <td>${new Date(bet.timestamp).toLocaleDateString()}</td>
            <td>
                <button class="btn" onclick="viewBet('${betId}')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
            </td>
        </tr>
    `).join('');
}

function filterBets() {
    const statusFilter = document.getElementById('betStatusFilter')?.value || 'all';
    const typeFilter = document.getElementById('betTypeFilter')?.value || 'all';
    const userFilter = document.getElementById('betUserFilter')?.value || '';
    
    return Object.entries(bets).filter(([betId, bet]) => {
        if (statusFilter !== 'all' && bet.status !== statusFilter) return false;
        if (typeFilter !== 'all' && bet.type !== typeFilter) return false;
        if (userFilter && !bet.user.toLowerCase().includes(userFilter.toLowerCase())) return false;
        return true;
    });
}

async function viewBet(betId) {
    const bet = bets[betId];
    if (!bet) {
        showNotification('–°—Ç–∞–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        return;
    }
    
    const potentialWin = (bet.amount * bet.coefficient).toFixed(2);
    const actualWin = bet.status === 'won' ? 
        (bet.winAmount || bet.amount * bet.coefficient).toFixed(2) : 0;
    
    const betDetails = document.getElementById('betDetails');
    betDetails.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>ID —Å—Ç–∞–≤–∫–∏:</strong> ${betId}<br>
            <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${bet.user}<br>
            <strong>–¢–∏–ø:</strong> ${bet.type === 'single' ? '–û–¥–∏–Ω–æ—á–Ω–∞—è' : '–≠–∫—Å–ø—Ä–µ—Å—Å'}<br>
            <strong>–°—É–º–º–∞:</strong> ${bet.amount} –ª—É–ø–∞–Ω—á–∏–∫–æ–≤<br>
            <strong>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:</strong> ${bet.coefficient}<br>
            <strong>–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:</strong> ${potentialWin} –ª—É–ø–∞–Ω—á–∏–∫–æ–≤<br>
            <strong>–°—Ç–∞—Ç—É—Å:</strong> ${getBetStatusName(bet.status)}<br>
            <strong>–î–∞—Ç–∞:</strong> ${new Date(bet.timestamp).toLocaleString()}
        </div>
        
        <div style="margin-bottom: 15px;">
            <strong>–°–æ–±—ã—Ç–∏—è:</strong><br>
            ${bet.events.map(event => `
                <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                    ${event.eventTitle} - ${event.option} (${event.coefficient})
                </div>
            `).join('')}
        </div>
        
        ${bet.status === 'won' ? `<div style="color: #4caf50;"><strong>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∏–≥—Ä—ã—à:</strong> ${actualWin} –ª—É–ø–∞–Ω—á–∏–∫–æ–≤</div>` : ''}
        ${bet.status === 'lost' ? `<div style="color: #f44336;"><strong>–ü—Ä–æ–∏–≥—Ä—ã—à:</strong> ${bet.amount} –ª—É–ø–∞–Ω—á–∏–∫–æ–≤</div>` : ''}
    `;
    
    const modal = document.getElementById('viewBetModal');
    if (modal) modal.style.display = 'block';
}

function getBetStatusName(status) {
    const statuses = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç',
        'won': '–í—ã–∏–≥—Ä–∞–ª–∞',
        'lost': '–ü—Ä–æ–∏–≥—Ä–∞–ª–∞',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
    };
    return statuses[status] || status;
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 400px;
        word-wrap: break-word;
    `;
    
    // –¶–≤–µ—Ç–∞ –ø–æ —Ç–∏–ø–∞–º
    const colors = {
        success: '#4caf50',
        error: '#f44336',
        warning: '#ff9800',
        info: '#2196f3'
    };
    
    notification.style.backgroundColor = colors[type] || colors.info;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ===== –≠–ö–°–ü–û–†–¢ –í–°–ï–• –§–£–ù–ö–¶–ò–ô –í –ì–õ–û–ë–ê–õ–¨–ù–£–Æ –û–ë–õ–ê–°–¢–¨ –í–ò–î–ò–ú–û–°–¢–ò =====
window.switchTab = switchTab;
window.addEvent = addEvent;
window.editEvent = editEvent;
window.deleteEvent = deleteEvent;
window.loadEvents = loadEvents;
window.loadBets = loadBets;
window.filterBets = filterBets;
window.viewBet = viewBet;
window.closeModal = closeModal;
window.logout = logout;
window.openFinishEventModal = openFinishEventModal;
window.finishEventConfirm = finishEventConfirm;
